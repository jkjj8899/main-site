name: 更新展示仓库的 README 产品列表

on:
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: 克隆展示仓库 product-site
        uses: actions/checkout@v3
        with:
          repository: jkjj8899/product-site
          token: ${{ secrets.GH_PAT }}

      - name: 安装依赖
        run: npm install axios

      - name: 自动更新 README
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GH_USERNAME: jkjj8899
        run: |
          node <<'EOF'
          const axios = require('axios');
          const fs = require('fs');

          const GH_TOKEN = process.env.GH_TOKEN;
          const USERNAME = process.env.GH_USERNAME;
          const SOURCE_REPO = "main-site";

          const headers = {
            Authorization: `token ${GH_TOKEN}`,
            Accept: 'application/vnd.github.v3+json'
          };

          (async () => {
            const response = await axios.get(
              `https://api.github.com/repos/${USERNAME}/${SOURCE_REPO}/contents/products.json`,
              { headers }
            );
            const products = JSON.parse(
              Buffer.from(response.data.content, 'base64').toString('utf-8')
            );

            let table = '<table>\n  <tr>';
            products.forEach((p, i) => {
              table += `
    <td align="center" width="50%" style="padding: 10px;">
      <img src="${p.icon}" width="100"/><br/>
      <b>${p.name}</b><br/>
      <p style="max-width: 240px; margin: 0 auto;">${p.description.length > 50 ? p.description.slice(0, 50) + '...' : p.description}</p>
      <a href="${p.link}" target="_blank">👉 访问页面</a>
    </td>`;
              if ((i + 1) % 2 === 0 && i !== products.length - 1) {
                table += '\n  </tr>\n  <tr>';
              }
            });
            table += '\n  </tr>\n</table>';

            const readme = fs.readFileSync('README.md', 'utf-8');
            const updated = readme.replace(
              /<!-- PRODUCT_LIST_START -->[\s\S]*<!-- PRODUCT_LIST_END -->/,
              `<!-- PRODUCT_LIST_START -->\n${table}\n<!-- PRODUCT_LIST_END -->`
            );

            fs.writeFileSync('README.md', updated);
            console.log('✅ README.md 已成功更新');
          })();
          EOF

      - name: 提交变更
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add README.md
          git commit -m "自动更新产品卡片列表" || echo "无变化"
          git push
